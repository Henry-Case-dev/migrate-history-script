# üöÄ Telegram History Migration Tool# üöÄ Telegram History Migration Tool# üöÄ Migrate History Script



> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ Telegram —á–∞—Ç–æ–≤ –≤ PostgreSQL —Å AI-–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ Gemini API



[![Go Version](https://img.shields.io/badge/Go-1.21+-00ADD8?style=flat&logo=go)](https://golang.org/)> –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ Telegram —á–∞—Ç–æ–≤ –≤ PostgreSQL —Å AI-–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ Gemini API–°–∫—Ä–∏–ø—Ç –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ Telegram —á–∞—Ç–æ–≤ –≤ PostgreSQL —Å –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ Gemini API.

[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-13+-336791?style=flat&logo=postgresql)](https://www.postgresql.org/)

[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)



---[![Go Version](https://img.shields.io/badge/Go-1.21+-00ADD8?style=flat&logo=go)](https://golang.org/)## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç



## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-13+-336791?style=flat&logo=postgresql)](https://www.postgresql.org/)



### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω)[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞



**Windows:**

```bash

# –°–∫–∞—á–∞–π—Ç–µ —É—Å—Ç–∞–Ω–æ–≤—â–∏–∫ —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞---```bash

https://go.dev/dl/

git clone https://github.com/Henry-Case-dev/migrate-history-script.git

# –ò–ª–∏ —á–µ—Ä–µ–∑ Chocolatey

choco install golang## üìñ –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µcd migrate-history-script

```

go mod download

**Linux/Mac:**

```bash- [–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç](#-–±—ã—Å—Ç—Ä—ã–π-—Å—Ç–∞—Ä—Ç)```

# Linux

sudo apt-get install golang-go- [–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è](#-—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è)



# Mac- [–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏](#-–æ—Å–Ω–æ–≤–Ω—ã–µ-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏)### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

brew install go

```- [–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è](#-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)



–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É:- [–†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã](#-—Ä–µ–∂–∏–º—ã-—Ä–∞–±–æ—Ç—ã)–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```bash

go version  # –î–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑–∞—Ç—å Go 1.21+- [–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º](#-—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ-–ø—Ä–æ—Ü–µ—Å—Å–æ–º)

```

- [–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º](#-—Ä–µ—à–µ–Ω–∏–µ-–ø—Ä–æ–±–ª–µ–º)```env

### 2. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

# PostgreSQL

```bash

# –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π---POSTGRESQL_HOST=your_host

git clone https://github.com/Henry-Case-dev/migrate-history-script.git

cd migrate-history-scriptPOSTGRESQL_PORT=5432



# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏## ‚ö° –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—ÇPOSTGRESQL_USER=your_user

go mod download

```POSTGRESQL_PASSWORD=your_password



### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞POSTGRESQL_DBNAME=your_database



–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:



```env```bash# Gemini API

# PostgreSQL

POSTGRESQL_HOST=your_host# –ö–ª–æ–Ω–∏—Ä—É–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–πGEMINI_API_KEY=your_gemini_api_key

POSTGRESQL_PORT=5432

POSTGRESQL_USER=your_usergit clone https://github.com/Henry-Case-dev/migrate-history-script.gitGEMINI_EMBEDDING_MODEL_NAME=embedding-001

POSTGRESQL_PASSWORD=your_password

POSTGRESQL_DBNAME=your_databasecd migrate-history-script



# Gemini API# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

GEMINI_API_KEY=your_gemini_api_key

GEMINI_EMBEDDING_MODEL_NAME=embedding-001# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏EMBEDDING_REQUESTS_PER_MINUTE=240



# Retry –Ω–∞—Å—Ç—Ä–æ–π–∫–∏go mod downloadEMBEDDING_REQUESTS_PER_DAY=24000

EMBEDDING_MAX_RETRIES=0  # 0 = –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º —Å 24—á —Ç–∞–π–º–∞—É—Ç–æ–º

```EMBEDDING_REQUEST_DELAY=0.3s

# Rate Limiting (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)

EMBEDDING_REQUESTS_PER_MINUTE=240EMBEDDING_BATCH_SIZE=100

EMBEDDING_REQUESTS_PER_DAY=24000

EMBEDDING_REQUEST_DELAY=0.3s### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `.env` —Ñ–∞–π–ª–∞EMBEDDING_CACHE_ENABLED=true

```



### 4. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:# Retry –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–ü–æ–º–µ—Å—Ç–∏—Ç–µ JSON —Ñ–∞–π–ª—ã —ç–∫—Å–ø–æ—Ä—Ç–∞ Telegram –≤ –ø–∞–ø–∫—É `data/`:

EMBEDDING_MAX_RETRIES=5  # 0 = –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º —Å 24—á —Ç–∞–π–º–∞—É—Ç–æ–º

```

data/```env```

‚îú‚îÄ‚îÄ chat_export_1.json

‚îú‚îÄ‚îÄ chat_export_2.json# ============================================

‚îî‚îÄ‚îÄ ...

```# PostgreSQL Configuration### 3. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö



### 5. –ó–∞–ø—É—Å–∫# ============================================



```bashPOSTGRESQL_HOST=localhost–ü–æ–º–µ—Å—Ç–∏—Ç–µ JSON —Ñ–∞–π–ª—ã —ç–∫—Å–ø–æ—Ä—Ç–∞ Telegram –≤ –ø–∞–ø–∫—É `data/`:

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

go run cmd/test_setup/main.goPOSTGRESQL_PORT=5432



# –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏POSTGRESQL_USER=your_user```

go run main.go

POSTGRESQL_PASSWORD=your_passworddata/

# –ò–ª–∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä—É–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ

go build -o migrate_history.exePOSTGRESQL_DBNAME=your_database‚îú‚îÄ‚îÄ chat_export_1.json

./migrate_history.exe

```‚îú‚îÄ‚îÄ chat_export_2.json



### 6. –û—Å—Ç–∞–Ω–æ–≤–∫–∞# ============================================‚îî‚îÄ‚îÄ ...



```bash# Gemini API Configuration```

# Graceful –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ (Ctrl+C)

# –ü—Ä–æ–≥—Ä–∞–º–º–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –ø–æ–∑–∂–µ# ============================================



# –ü—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏GEMINI_API_KEY=your_gemini_api_key### 4. –ó–∞–ø—É—Å–∫

./migrate_history.exe

```GEMINI_EMBEDDING_MODEL_NAME=embedding-001



---```bash



## üìã –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏# ============================================# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫



- ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è JSON ‚Üí PostgreSQL** - –ø–µ—Ä–µ–Ω–æ—Å –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã# Migration Settingsgo run cmd/test_setup/main.go

- ‚úÖ **AI-–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - —É–º–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ —á–µ—Ä–µ–∑ Gemini API

- ‚úÖ **–í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞/–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö# ============================================

- ‚úÖ **–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π retry —Ä–µ–∂–∏–º** - –≥–∞—Ä–∞–Ω—Ç–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (EMBEDDING_MAX_RETRIES=0)

- ‚úÖ **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–ø—É—Å–∫ —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–πEMBEDDING_MAX_RETRIES=5              # 0 = –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ retry (24—á —Ç–∞–π–º–∞—É—Ç)# –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏

- ‚úÖ **–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

- ‚úÖ **Rate limiting** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –∫–≤–æ—Ç APIEMBEDDING_BATCH_SIZE=100             # –†–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–πgo run main.go

- ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤** - —ç–∫–æ–Ω–æ–º–∏—è API –≤—ã–∑–æ–≤–æ–≤

EMBEDDING_CACHE_ENABLED=true        # –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

---

# –ò–ª–∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

# ============================================go build -o migrate_history.exe

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–µ—Ä—Å–∏—è | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |

|-----------|--------|------------|# Rate Limiting (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è)./migrate_history.exe

| **Go** | 1.21+ | –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è |

| **PostgreSQL** | 13+ —Å pgvector | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º |# ============================================```

| **Gemini API** | Tier 1+ | –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (240 req/min) |

| **–î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ** | ~500MB | –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö |EMBEDDING_REQUESTS_PER_MINUTE=240



### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pgvectorEMBEDDING_REQUESTS_PER_DAY=24000## üìã –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏



```sqlEMBEDDING_REQUEST_DELAY=0.3s

-- –í PostgreSQL –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:

CREATE EXTENSION IF NOT EXISTS vector;```- ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏—è JSON ‚Üí PostgreSQL** - –ø–µ—Ä–µ–Ω–æ—Å –≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

```

- ‚úÖ **–ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** - —É–º–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞  

---

### –®–∞–≥ 3: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö- ‚úÖ **–í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º–∞—è –º–∏–≥—Ä–∞—Ü–∏—è** - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞/–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö

## üîÑ –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

- ‚úÖ **–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä** - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

### üõ°Ô∏è –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º (–†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –¥–ª—è production)

–ü–æ–º–µ—Å—Ç–∏—Ç–µ JSON —Ñ–∞–π–ª—ã —ç–∫—Å–ø–æ—Ä—Ç–∞ Telegram –≤ –ø–∞–ø–∫—É `data/`:- ‚úÖ **Rate limiting** - –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –∫–≤–æ—Ç API

```env

EMBEDDING_MAX_RETRIES=0  # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º- ‚úÖ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤** - —ç–∫–æ–Ω–æ–º–∏—è API –≤—ã–∑–æ–≤–æ–≤

```

```- ‚úÖ **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**

- ‚úÖ **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è** - –≥–∞—Ä–∞–Ω—Ç–∏—è –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ödata/

- ‚úÖ –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ —É—Å–ø–µ—Ö–∞ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–∞ (24 —á–∞—Å–∞)

- ‚úÖ –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ **60 –º–∏–Ω—É—Ç** –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏‚îú‚îÄ‚îÄ chat_export_1.json## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- ‚úÖ –ü–æ—Å–ª–µ —Ç–∞–π–º–∞—É—Ç–∞ - **–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã** —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è

- ‚úÖ –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å —Ç–æ–≥–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è‚îú‚îÄ‚îÄ chat_export_2.json



**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** production, –∫–æ–≥–¥–∞ –≤–∞–∂–Ω–∞ –ø–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö‚îî‚îÄ‚îÄ chat_export_N.json- **Go 1.21+** 



### üéØ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º```- **PostgreSQL** —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º pgvector



```env- **Gemini API –∫–ª—é—á** (tier 1 —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

EMBEDDING_MAX_RETRIES=5  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫

```### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫- **~500MB** —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –≤ –ë–î



**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**- **~$10-15** –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–æ–ª—å—à–æ–≥–æ –∞—Ä—Ö–∏–≤–∞

- ‚úÖ –î–µ–ª–∞–µ—Ç 5 –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

- ‚úÖ –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 2—Å ‚Üí 4—Å ‚Üí 8—Å ‚Üí 16—Å ‚Üí 32—Å (max 60—Å)```bash

- ‚ö†Ô∏è –ü—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –ø–æ–ø—ã—Ç–æ–∫ - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î –∏ API## üîß –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, –±—ã—Å—Ç—Ä–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

go run cmd/test_setup/main.go

---

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

## üö¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é

### –ó–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞

go run main.go```env

```bash

# –ó–∞–ø—É—Å–∫# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

./migrate_history.exe

# –ò–ª–∏ —Å–∫–æ–º–ø–∏–ª–∏—Ä—É–π—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µEMBEDDING_BATCH_SIZE=100

# Graceful –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ)

Ctrl+Cgo build -o migrate_history.exeEMBEDDING_BATCH_DELAY=60s



# –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç)./migrate_history.exeEMBEDDING_REQUESTS_PER_MINUTE=240

./migrate_history.exe

```EMBEDDING_REQUEST_DELAY=0.3s

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ (Linux/Mac)

nohup ./migrate_history.exe > migration.log 2>&1 &



# Windows (PowerShell)---# Retry –º–µ—Ö–∞–Ω–∏–∑–º

Start-Process -NoNewWindow -FilePath ".\migrate_history.exe" -RedirectStandardOutput "migration.log" -RedirectStandardError "errors.log"

```EMBEDDING_MAX_RETRIES=5        # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö



### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è                               # 0 = –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º —Å 24—á —Ç–∞–π–º–∞—É—Ç–æ–º



```bash

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

tail -f migration.log| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –í–µ—Ä—Å–∏—è | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ



# –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏|-----------|--------|------------|EMBEDDING_CACHE_ENABLED=true

cat migration_state.json | jq '.'

| **Go** | 1.21+ | –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è |EMBEDDING_CACHE_DIR=./cache/embeddings

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç API

grep "Rate limit\|API:" migration.log| **PostgreSQL** | 13+ —Å pgvector | –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å –≤–µ–∫—Ç–æ—Ä–Ω—ã–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º |

```

| **Gemini API** | Tier 1+ | –î–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ |# –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î

| **–î–∏—Å–∫–æ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ** | ~500MB | –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö |MIGRATION_RESUME_ENABLED=true

```sql

-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞| **–ë—é–¥–∂–µ—Ç API** | ~$10-15 | –î–ª—è –±–æ–ª—å—à–æ–≥–æ –∞—Ä—Ö–∏–≤–∞ (–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–æ) |MIGRATION_STATE_FILE=./migration_state.json

SELECT 

    COUNT(*) as total_messages,```

    COUNT(embedding) as vectorized_messages,

    ROUND(COUNT(embedding) * 100.0 / COUNT(*), 2) as percent### –£—Å—Ç–∞–Ω–æ–≤–∫–∞ pgvector

FROM messages;

### Retry –º–µ—Ö–∞–Ω–∏–∑–º

-- –¢–æ–ø-10 —á–∞—Ç–æ–≤

SELECT chat_id, COUNT(*) as messages```sql

FROM messages 

GROUP BY chat_id -- –í PostgreSQL –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:–°–∫—Ä–∏–ø—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ —Ä–µ–∂–∏–º–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫:

ORDER BY messages DESC 

LIMIT 10;CREATE EXTENSION IF NOT EXISTS vector;

```

```#### –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º (EMBEDDING_MAX_RETRIES > 0)

---

- –î–µ–ª–∞–µ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

## üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤

---- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 2—Å ‚Üí 4—Å ‚Üí 8—Å ‚Üí 16—Å ‚Üí 32—Å (–º–∞–∫—Å–∏–º—É–º 60—Å)

–ü—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ –¥—Ä—É–≥—É—é –º–∞—à–∏–Ω—É **–¥–∞–Ω–Ω—ã–µ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è**:

- –ü—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –ø–æ–ø—ã—Ç–æ–∫ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É

1. ‚úÖ `migration_state.json` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –∏–Ω–¥–µ–∫—Å—ã

2. ‚úÖ PostgreSQL UNIQUE constraint –Ω–∞ `(chat_id, message_id)`## ‚ú® –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

3. ‚úÖ `INSERT ... ON CONFLICT DO NOTHING` —Å—Ç—Ä–∞—Ç–µ–≥–∏—è

**–ü—Ä–∏–º–µ—Ä**: `EMBEDDING_MAX_RETRIES=5` - 5 –ø–æ–ø—ã—Ç–æ–∫, –∑–∞—Ç–µ–º –æ—à–∏–±–∫–∞

**–î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞:**

```bash| –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |

# 1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª —Å–æ—Å—Ç–æ—è–Ω–∏—è

scp migration_state.json user@server:/path/|------------|----------|#### –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º (EMBEDDING_MAX_RETRIES = 0)



# 2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL –¥–æ—Å—Ç—É–ø–Ω–∞| üîÑ **–ú–∏–≥—Ä–∞—Ü–∏—è JSON ‚Üí PostgreSQL** | –ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã |- **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è** - –≥–∞—Ä–∞–Ω—Ç–∏—è –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö

psql -h your_host -U your_user -d your_database -c "SELECT COUNT(*) FROM messages;"

| üß† **AI-–≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è** | –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ —ç–º–±–µ–¥–¥–∏–Ω–≥–∏ —á–µ—Ä–µ–∑ Gemini API |- –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –ø–æ–ø—ã—Ç–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–æ —É—Å–ø–µ—Ö–∞ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–∞

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ - –ø—Ä–æ–≥—Ä–∞–º–º–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

./migrate_history.exe| üíæ **–í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º–æ—Å—Ç—å** | –û—Å—Ç–∞–Ω–æ–≤–∫–∞/–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ |- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ **60 –º–∏–Ω—É—Ç** –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏

```

| üìä **–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä** | –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ |- –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è 60 –º–∏–Ω—É—Ç - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤ 60 –º–∏–Ω—É—Ç

---

| ‚ö° **Rate Limiting** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –∫–≤–æ—Ç |- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: 24 —á–∞—Å–∞ –Ω–∞ –æ–¥–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ

## üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

| üí∞ **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** | –≠–∫–æ–Ω–æ–º–∏—è API –≤—ã–∑–æ–≤–æ–≤ |- –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ - **–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã** —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è

### ‚ùå –û—à–∏–±–∫–∞: "Cannot connect to PostgreSQL"

| üîç **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è** | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π |

```bash

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ| üõ°Ô∏è **–ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤** | UNIQUE constraints –Ω–∞ message_id |**–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production**: –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç —á—Ç–æ –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã

psql -h your_host -p 5432 -U your_user -d your_database



# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ pgvector

psql -h your_host -U your_user -d your_database -c "SELECT * FROM pg_extension WHERE extname='vector';"---**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:**

```

- `EMBEDDING_MAX_RETRIES=5` - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±—ã—Å—Ç—Ä–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (host, port, user, password)## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è- `EMBEDDING_MAX_RETRIES=0` - –¥–ª—è production, –∫–æ–≥–¥–∞ –≤–∞–∂–Ω–∞ –ø–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö

- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω

- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pgvector: `CREATE EXTENSION vector;`



### ‚è±Ô∏è –¢–∞–π–º–∞—É—Ç 24 —á–∞—Å–∞ (EMBEDDING_MAX_RETRIES=0)### –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã### –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—è



```

‚ùå [CRITICAL] –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ 12345 –∑–∞ 24 —á–∞—Å–∞.

``````env–°–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –æ–∫–Ω–∞:



**–ü—Ä–∏—á–∏–Ω—ã:**# –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- –ü—Ä–æ–±–ª–µ–º—ã —Å Gemini API (–ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–∞)

- –ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ –∫–≤–æ—Ç APIEMBEDDING_BATCH_SIZE=100              # –°–æ–æ–±—â–µ–Ω–∏–π –≤ –ø–∞–∫–µ—Ç–µ (50-200)- **–ë–∞–∑–æ–≤–æ–µ –æ–∫–Ω–æ**: 5+5 —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

- –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

EMBEDDING_BATCH_DELAY=60s             # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–∞–∫–µ—Ç–∞–º–∏- **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ**: 15+15 –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∏–∞–ª–æ–≥–æ–≤ (reply chains)  

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å Gemini API- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ**: 25+25 –¥–ª—è –≤–∞–∂–Ω—ã—Ö –¥–∏—Å–∫—É—Å—Å–∏–π

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–≤–æ—Ç—ã: https://aistudio.google.com/app/apikey

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ# Rate Limiting- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —à—É–º–∞**: –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö/–ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π

4. –ü–æ—Å–ª–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è - –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç

EMBEDDING_REQUESTS_PER_MINUTE=240    # –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É

### üö´ –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ API

EMBEDDING_REQUESTS_PER_DAY=24000     # –õ–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å## üö¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º

```bash

# –†–µ—à–µ–Ω–∏–µ 1: –£–º–µ–Ω—å—à–∏—Ç–µ –ª–∏–º–∏—Ç—ã –≤ .envEMBEDDING_REQUEST_DELAY=0.3s         # –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

EMBEDDING_REQUESTS_PER_MINUTE=120  # –ë—ã–ª–æ 240

EMBEDDING_REQUEST_DELAY=0.6s       # –ë—ã–ª–æ 0.3s### –ó–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞



# –†–µ—à–µ–Ω–∏–µ 2: –ü–æ–¥–æ–∂–¥–∏—Ç–µ —Å–±—Ä–æ—Å–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)# –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ

# Tier 1: –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É/–¥–µ–Ω—å

EMBEDDING_CACHE_ENABLED=true         # –í–∫–ª—é—á–∏—Ç—å –∫—ç—à```bash

# –†–µ—à–µ–Ω–∏–µ 3: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–ª—é—á

GEMINI_API_KEY=your_backup_keyEMBEDDING_CACHE_DIR=./cache/embeddings# Graceful –æ—Å—Ç–∞–Ω–æ–≤–∫–∞

```

Ctrl+C

---

# –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

MIGRATION_RESUME_ENABLED=true        # –í–∫–ª—é—á–∏—Ç—å —Ä–µ–∑—é–º# –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏)

```sql

CREATE TABLE messages (MIGRATION_STATE_FILE=./migration_state.json./migrate_history.exe

    id SERIAL PRIMARY KEY,

    chat_id BIGINT NOT NULL,```

    message_id INTEGER NOT NULL,

    user_id BIGINT,# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ

    username TEXT,

    text TEXT,### –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–∞—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏—ènohup ./migrate_history.exe > migration.log 2>&1 &

    date_sent TIMESTAMP WITH TIME ZONE,

    embedding vector(768),        -- Gemini embedding-001```

    context_text TEXT,

    UNIQUE(chat_id, message_id)–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

);

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞

CREATE INDEX messages_embedding_idx - **–ë–∞–∑–æ–≤–æ–µ –æ–∫–Ω–æ**: 5¬±5 —Å–æ–æ–±—â–µ–Ω–∏–π (–æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)

ON messages 

USING ivfflat (embedding vector_cosine_ops);- **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ**: 15¬±15 (reply chains)```bash

```

- **–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ**: 25¬±25 (–≤–∞–∂–Ω—ã–µ –¥–∏—Å–∫—É—Å—Å–∏–∏)# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

---

- **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —à—É–º–∞**: –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—Ä–æ—Ç–∫–∏—Ö/–ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–πtail -f migration.log

## üéØ –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (–ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏)



```sql

-- –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫)---# –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏

SELECT 

    text,cat migration_state.json | jq '.'

    embedding <=> '[your_vector]'::vector as distance

FROM messages ## üîÑ –†–µ–∂–∏–º—ã —Ä–∞–±–æ—Ç—ã

WHERE embedding IS NOT NULL

ORDER BY distance ASC # API –∫–≤–æ—Ç—ã

LIMIT 10;

### üéØ –†–µ–∂–∏–º 1: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ retry (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)grep "Rate limit\|API:" migration.log

-- –ü–æ–∏—Å–∫ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —á–∞—Ç–µ

SELECT text, embedding <=> '[vector]'::vector as dist```

FROM messages 

WHERE chat_id = 123456 AND embedding IS NOT NULL```env

ORDER BY dist ASC 

LIMIT 5;EMBEDDING_MAX_RETRIES=5  # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ

```

```

---

–ü—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ –¥—Ä—É–≥—É—é –º–∞—à–∏–Ω—É **—É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–æ–≤—Ç–æ—Ä–Ω–æ** –±–ª–∞–≥–æ–¥–∞—Ä—è:

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**

```

migrate-history-script/- ‚úÖ –î–µ–ª–∞–µ—Ç 5 –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö1. **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è** - —Ñ–∞–π–ª `migration_state.json` —Ö—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–∞—Ö

‚îú‚îÄ‚îÄ main.go                    # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª (–º–∏–≥—Ä–∞—Ü–∏—è, retry –ª–æ–≥–∏–∫–∞)

‚îú‚îÄ‚îÄ internal/- ‚úÖ –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 2—Å ‚Üí 4—Å ‚Üí 8—Å ‚Üí 16—Å ‚Üí 32—Å (max 60—Å)2. **Database constraints** - PostgreSQL UNIQUE –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞ `(chat_id, message_id)`

‚îÇ   ‚îú‚îÄ‚îÄ config/                # –ó–∞–≥—Ä—É–∑–∫–∞ .env –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

‚îÇ   ‚îú‚îÄ‚îÄ storage/               # PostgreSQL –∫–ª–∏–µ–Ω—Ç- ‚ö†Ô∏è –ü—Ä–∏ –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –ø–æ–ø—ã—Ç–æ–∫ - –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É3. **ON CONFLICT —Å—Ç—Ä–∞—Ç–µ–≥–∏—è** - `INSERT ... ON CONFLICT DO NOTHING` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ

‚îÇ   ‚îú‚îÄ‚îÄ gemini/                # Gemini API –∫–ª–∏–µ–Ω—Ç

‚îÇ   ‚îú‚îÄ‚îÄ llm/                   # LLM –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

‚îÇ   ‚îî‚îÄ‚îÄ utils/                 # –£—Ç–∏–ª–∏—Ç—ã

‚îú‚îÄ‚îÄ cmd/**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –±—ã—Å—Ç—Ä–∞—è –º–∏–≥—Ä–∞—Ü–∏—è, —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**–î–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞:**

‚îÇ   ‚îî‚îÄ‚îÄ test_setup/            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î/API

‚îú‚îÄ‚îÄ data/                      # JSON —ç–∫—Å–ø–æ—Ä—Ç—ã Telegram (–¥–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞)

‚îú‚îÄ‚îÄ cache/                     # –ö—ç—à —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

‚îú‚îÄ‚îÄ migration_state.json       # –°–æ—Å—Ç–æ—è–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)---1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ `migration_state.json` 

‚îî‚îÄ‚îÄ .env                       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Å–æ–∑–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é)

```2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL —Å–æ–¥–µ—Ä–∂–∏—Ç —É–∂–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ



---### üõ°Ô∏è –†–µ–∂–∏–º 2: –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–µ retry (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è production)3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç - –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã



## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å



### Rate Limiting```env## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö



| Tier | Requests/min | Requests/day | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ |EMBEDDING_MAX_RETRIES=0  # –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º

|------|--------------|--------------|--------------|

| **Free** | 15 | 1,500 | –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª—å—à–∏—Ö –∞—Ä—Ö–∏–≤–æ–≤ |```–°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É `messages`:

| **Tier 1** | 240 | 24,000 | ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |

| **Tier 2** | 1,000+ | 100,000+ | –î–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –∞—Ä—Ö–∏–≤–æ–≤ |



### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏**–ü–æ–≤–µ–¥–µ–Ω–∏–µ:**```sql



- ‚ö° –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (50 —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –±–∞—Ç—á–µ)- ‚úÖ **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è** - –≥–∞—Ä–∞–Ω—Ç–∏—è –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—ÖCREATE TABLE messages (

- üíæ –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

- üîÑ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤- ‚úÖ –ü–æ–≤—Ç–æ—Ä—è–µ—Ç –¥–æ —É—Å–ø–µ—Ö–∞ –∏–ª–∏ —Ç–∞–π–º–∞—É—Ç–∞ (24 —á–∞—Å–∞)    id SERIAL PRIMARY KEY,

- üìâ –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ –ª–∏–º–∏—Ç–∞—Ö

- üéØ –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Ç–æ—á–Ω–æ–≥–æ checkpoint –±–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏- ‚úÖ –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–æ 60 –º–∏–Ω—É—Ç    chat_id BIGINT NOT NULL,



---- ‚úÖ –ó–∞—Ç–µ–º —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤ 60 –º–∏–Ω—É—Ç    message_id INTEGER NOT NULL,



## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞- ‚úÖ –ü—Ä–∏ —Ç–∞–π–º–∞—É—Ç–µ - **–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã** —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è    user_id BIGINT,



**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º:**    username TEXT,



```bash**–ü—Ä–∏–º–µ—Ä –ª–æ–≥–æ–≤:**    text TEXT,

# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫

go run cmd/test_setup/main.go    date_sent TIMESTAMP WITH TIME ZONE,



# 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏```    embedding vector(768),

tail -n 100 migration.log

‚è≥ [–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∂–∏–º] –ü–æ–ø—ã—Ç–∫–∞ 15 | –ü—Ä–æ—à–ª–æ: 8h 30m | –û—Å—Ç–∞–ª–æ—Å—å: 15h 30m | –°–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑: 60m    context_text TEXT,

# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

cat migration_state.json | jq '.'‚úÖ [Success] –°–æ–æ–±—â–µ–Ω–∏–µ 12345 —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø–æ—Å–ª–µ 15 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 8h 35m    UNIQUE(chat_id, message_id)

```

```);

**–ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã:**

- [Gemini API Documentation](https://ai.google.dev/docs)```

- [PostgreSQL pgvector](https://github.com/pgvector/pgvector)

- [Issues](https://github.com/Henry-Case-dev/migrate-history-script/issues)**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** production, –∫–æ–≥–¥–∞ –≤–∞–∂–Ω–∞ –ø–æ–ª–Ω–æ—Ç–∞ –¥–∞–Ω–Ω—ã—Ö



---### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞



## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è---



MIT License - —Å–º. [LICENSE](LICENSE)```sql



---## üö¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–º-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞



<div align="center">SELECT 



**–ê–≤—Ç–æ—Ä:** [Henry-Case-dev](https://github.com/Henry-Case-dev)  ### –ó–∞–ø—É—Å–∫ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞    COUNT(*) as total_messages,

**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** [migrate-history-script](https://github.com/Henry-Case-dev/migrate-history-script)  

    COUNT(embedding) as vectorized_messages,

‚≠ê –ü–æ—Å—Ç–∞–≤—å—Ç–µ –∑–≤–µ–∑–¥—É, –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –±—ã–ª –ø–æ–ª–µ–∑–µ–Ω!

```bash    ROUND(COUNT(embedding) * 100.0 / COUNT(*), 2) as vectorization_percent

</div>

# –ó–∞–ø—É—Å–∫FROM messages;

./migrate_history.exe

-- –¢–æ–ø —á–∞—Ç—ã –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–æ–æ–±—â–µ–Ω–∏–π

# Graceful –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ)SELECT chat_id, COUNT(*) as messages

Ctrl+CFROM messages 

GROUP BY chat_id 

# –í–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç)ORDER BY messages DESC 

./migrate_history.exeLIMIT 10;

```

# –ó–∞–ø—É—Å–∫ –≤ —Ñ–æ–Ω–µ (Linux/Mac)

nohup ./migrate_history.exe > migration.log 2>&1 &## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

```

### Rate Limiting

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- **Tier 1 Gemini**: 240 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω, 24,000/–¥–µ–Ω—å

```bash- **–ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ** –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–æ–≤

# –õ–æ–≥–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏- **–≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞** –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

tail -f migration.log

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

# –°—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–∏ (JSON)

cat migration_state.json- **–ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞**: 50-100 —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ —Ä–∞–∑

- **–õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à** —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Å jq)- **–î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è** –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤

cat migration_state.json | jq '.processed_count, .vectorized_count, .total_messages'

## üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–æ—Ç API

grep "Rate limit\|API:" migration.log### –û—à–∏–±–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL

```

```bash

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ –ë–î# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

psql -h your_host -p 5432 -U your_user -d your_database

```sql```

-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

SELECT ### –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–æ–≤ API

    COUNT(*) as total_messages,

    COUNT(embedding) as vectorized_messages,- –ü–æ–¥–æ–∂–¥–∏—Ç–µ —Å–±—Ä–æ—Å–∞ –ª–∏–º–∏—Ç–æ–≤ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É/–¥–µ–Ω—å)

    ROUND(COUNT(embedding) * 100.0 / COUNT(*), 2) as percent- –£–º–µ–Ω—å—à–∏—Ç–µ `EMBEDDING_REQUESTS_PER_MINUTE` –≤ .env

FROM messages;- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π API –∫–ª—é—á



-- –¢–æ–ø-10 —á–∞—Ç–æ–≤### 24-—á–∞—Å–æ–≤–æ–π —Ç–∞–π–º–∞—É—Ç (EMBEDDING_MAX_RETRIES=0)

SELECT chat_id, COUNT(*) as messages

FROM messages –ï—Å–ª–∏ –ø—Ä–æ–≥—Ä–∞–º–º–∞ –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∑–∞ 24 —á–∞—Å–∞":

GROUP BY chat_id 

ORDER BY messages DESC 1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ Gemini API** - –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–±–ª–µ–º—ã –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ —Å–µ—Ä–≤–∏—Å–∞

LIMIT 10;2. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á** - —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –∫–≤–æ—Ç—ã –Ω–µ –∏—Å—á–µ—Ä–ø–∞–Ω—ã

```3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ** - —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

4. **–ü–æ—Å–ª–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã** –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç - –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

---

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø–µ—Ä–µ–Ω–æ—Å

- –£–º–µ–Ω—å—à–∏—Ç–µ `EMBEDDING_BATCH_SIZE`

### –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤- –£–≤–µ–ª–∏—á—å—Ç–µ `EMBEDDING_BATCH_DELAY`  

- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ—Ü–µ—Å—Å

–ü—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ –¥—Ä—É–≥—É—é –º–∞—à–∏–Ω—É **–¥–∞–Ω–Ω—ã–µ –Ω–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è**:

### –û—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON

1. ‚úÖ `migration_state.json` - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

2. ‚úÖ PostgreSQL UNIQUE constraint –Ω–∞ `(chat_id, message_id)`- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–¥–∏—Ä–æ–≤–∫—É —Ñ–∞–π–ª–æ–≤ (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å UTF-8)

3. ‚úÖ `INSERT ... ON CONFLICT DO NOTHING` —Å—Ç—Ä–∞—Ç–µ–≥–∏—è- –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

- –ò—Å–∫–ª—é—á–∏—Ç–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ö–∞–∫ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ –¥—Ä—É–≥–æ–π —Å–µ—Ä–≤–µ—Ä

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```bash

# 1. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã```

scp migration_state.json user@server:/path/migrate-history-script/

scp .env user@server:/path/‚îú‚îÄ‚îÄ main.go                    # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–æ–≥—Ä–∞–º–º—ã

‚îú‚îÄ‚îÄ internal/                  # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–∞–∫–µ—Ç—ã

# 2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL –¥–æ—Å—Ç—É–ø–Ω–∞‚îÇ   ‚îú‚îÄ‚îÄ config/               # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

psql -h your_host -U your_user -d your_database -c "SELECT COUNT(*) FROM messages;"‚îÇ   ‚îú‚îÄ‚îÄ storage/              # –†–∞–±–æ—Ç–∞ —Å PostgreSQL

‚îÇ   ‚îú‚îÄ‚îÄ gemini/               # –ö–ª–∏–µ–Ω—Ç Gemini API

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ - –æ–Ω –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏‚îÇ   ‚îú‚îÄ‚îÄ llm/                  # –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã LLM

./migrate_history.exe‚îÇ   ‚îî‚îÄ‚îÄ utils/                # –£—Ç–∏–ª–∏—Ç—ã

```‚îú‚îÄ‚îÄ cmd/

‚îÇ   ‚îî‚îÄ‚îÄ test_setup/           # –°–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫

---‚îú‚îÄ‚îÄ data/                     # JSON —Ñ–∞–π–ª—ã —ç–∫—Å–ø–æ—Ä—Ç–∞ Telegram

‚îú‚îÄ‚îÄ cache/                    # –ö—ç—à —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤

## üîß –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º‚îú‚îÄ‚îÄ migration_state.json     # –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (–∞–≤—Ç–æ—Å–æ–∑–¥–∞–µ—Ç—Å—è)

‚îî‚îÄ‚îÄ .env                      # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Å–æ–∑–¥–∞—Ç—å —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ)

### ‚ùå –û—à–∏–±–∫–∞: "Cannot connect to PostgreSQL"```



```bash## üéØ –ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

psql -h your_host -p 5432 -U your_user -d your_database1. **–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –±–æ—Ç–∞** –Ω–∞ PostgreSQL storage

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞** 

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ pgvector3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω–¥–µ–∫—Å–æ–≤** –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

psql -h your_host -U your_user -d your_database -c "SELECT * FROM pg_extension WHERE extname='vector';"4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏**

```

## üìà –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫

**–†–µ—à–µ–Ω–∏–µ:**

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `.env` –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (host, port, user, password)–ü–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫:

- –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω

- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ pgvector: `CREATE EXTENSION vector;````sql

-- –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π

---SELECT 

    text,

### ‚è±Ô∏è –û—à–∏–±–∫–∞: "–ü—Ä–µ–≤—ã—à–µ–Ω–æ 24 —á–∞—Å–∞" (EMBEDDING_MAX_RETRIES=0)    embedding <=> '[vector_here]'::vector as distance

FROM messages 

```WHERE embedding IS NOT NULL

‚ùå [CRITICAL] –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ 12345 –∑–∞ 24 —á–∞—Å–∞.ORDER BY distance ASC 

```LIMIT 10;



**–ü—Ä–∏—á–∏–Ω—ã:**-- –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞

- –ü—Ä–æ–±–ª–µ–º—ã —Å Gemini API (–ø–µ—Ä–µ–≥—Ä—É–∑–∫–∞ —Å–µ—Ä–≤–∏—Å–∞)CREATE INDEX ON messages USING ivfflat (embedding vector_cosine_ops);

- –ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ –∫–≤–æ—Ç API```

- –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å Gemini API–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–≤–æ—Ç—ã: https://aistudio.google.com/app/apikey

3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `go run cmd/test_setup/main.go` –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

4. –ü–æ—Å–ª–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è - –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ —Ñ–∞–π–ª–µ `migration.log`

3. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ `.env` —Ñ–∞–π–ª–µ

---

---

### üö´ –û—à–∏–±–∫–∞: "Rate limit exceeded"

**–ê–≤—Ç–æ—Ä**: Henry-Case-dev  

```bash**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**: https://github.com/Henry-Case-dev/migrate-history-script  

# –†–µ—à–µ–Ω–∏–µ 1: –£–º–µ–Ω—å—à–∏—Ç–µ –ª–∏–º–∏—Ç—ã –≤ .env**–í–µ—Ä—Å–∏—è**: 1.0.0  

EMBEDDING_REQUESTS_PER_MINUTE=120  # –ë—ã–ª–æ 240**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –°–µ–Ω—Ç—è–±—Ä—å 2025
EMBEDDING_REQUEST_DELAY=0.6s       # –ë—ã–ª–æ 0.3s

# –†–µ—à–µ–Ω–∏–µ 2: –ü–æ–¥–æ–∂–¥–∏—Ç–µ —Å–±—Ä–æ—Å–∞ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
# Tier 1: –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É/–¥–µ–Ω—å

# –†–µ—à–µ–Ω–∏–µ 3: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –∫–ª—é—á
GEMINI_API_KEY=your_backup_key
```

---

### üíæ –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é

**–°–∏–º–ø—Ç–æ–º—ã:** –ø—Ä–æ—Ü–µ—Å—Å —É–±–∏–≤–∞–µ—Ç—Å—è –û–°, –ø–∞–¥–∞–µ—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–†–µ—à–µ–Ω–∏–µ:**
```env
EMBEDDING_BATCH_SIZE=50              # –£–º–µ–Ω—å—à–∏—Ç—å —Å 100
EMBEDDING_BATCH_DELAY=120s           # –£–≤–µ–ª–∏—á–∏—Ç—å —Å 60s
```

---

### üìù –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –∫–æ–¥–∏—Ä–æ–≤–∫–µ UTF-8
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å JSON: `jq '.' data/your_file.json`
- –ò—Å–∫–ª—é—á–∏—Ç–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏ `data/`

---

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```sql
CREATE TABLE messages (
    id SERIAL PRIMARY KEY,
    chat_id BIGINT NOT NULL,
    message_id INTEGER NOT NULL,
    user_id BIGINT,
    username TEXT,
    text TEXT,
    date_sent TIMESTAMP WITH TIME ZONE,
    embedding vector(768),        -- Gemini embedding-001
    context_text TEXT,
    UNIQUE(chat_id, message_id)
);

-- –ò–Ω–¥–µ–∫—Å –¥–ª—è –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX messages_embedding_idx 
ON messages 
USING ivfflat (embedding vector_cosine_ops);
```

---

## üéØ –í–µ–∫—Ç–æ—Ä–Ω—ã–π –ø–æ–∏—Å–∫ (–ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏)

```sql
-- –ü–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫)
SELECT 
    text,
    embedding <=> '[your_vector]'::vector as distance
FROM messages 
WHERE embedding IS NOT NULL
ORDER BY distance ASC 
LIMIT 10;

-- –ü–æ–∏—Å–∫ –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º —á–∞—Ç–µ
SELECT text, embedding <=> '[vector]'::vector as dist
FROM messages 
WHERE chat_id = 123456 AND embedding IS NOT NULL
ORDER BY dist ASC 
LIMIT 5;
```

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
migrate-history-script/
‚îú‚îÄ‚îÄ üìÑ main.go                    # –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª (–º–∏–≥—Ä–∞—Ü–∏—è, retry –ª–æ–≥–∏–∫–∞)
‚îú‚îÄ‚îÄ üì¶ internal/
‚îÇ   ‚îú‚îÄ‚îÄ config/                  # –ó–∞–≥—Ä—É–∑–∫–∞ .env –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ storage/                 # PostgreSQL –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ gemini/                  # Gemini API –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ llm/                     # LLM –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
‚îÇ   ‚îî‚îÄ‚îÄ utils/                   # –£—Ç–∏–ª–∏—Ç—ã
‚îú‚îÄ‚îÄ üß™ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ test_setup/              # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ë–î/API
‚îú‚îÄ‚îÄ üìÇ data/                     # JSON —ç–∫—Å–ø–æ—Ä—Ç—ã Telegram (–¥–æ–±–∞–≤—å—Ç–µ —Å—é–¥–∞)
‚îú‚îÄ‚îÄ üíæ cache/                    # –ö—ç—à —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
‚îú‚îÄ‚îÄ üìä migration_state.json      # –°–æ—Å—Ç–æ—è–Ω–∏–µ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
‚îî‚îÄ‚îÄ ‚öôÔ∏è .env                       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (—Å–æ–∑–¥–∞–π—Ç–µ –≤—Ä—É—á–Ω—É—é)
```

---

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### Rate Limiting

| Tier | Requests/min | Requests/day | –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ |
|------|--------------|--------------|--------------|
| **Free** | 15 | 1,500 | –ù–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–æ–ª—å—à–∏—Ö –∞—Ä—Ö–∏–≤–æ–≤ |
| **Tier 1** | 240 | 24,000 | ‚úÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è |
| **Tier 2** | 1,000+ | 100,000+ | –î–ª—è –æ—á–µ–Ω—å –±–æ–ª—å—à–∏—Ö –∞—Ä—Ö–∏–≤–æ–≤ |

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏

- ‚ö° –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (50-100 —Å–æ–æ–±—â–µ–Ω–∏–π)
- üíæ –õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
- üîÑ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤
- üìâ –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –∑–∞–º–µ–¥–ª–µ–Ω–∏–µ –ø—Ä–∏ –ª–∏–º–∏—Ç–∞—Ö

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º:**

```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
go run cmd/test_setup/main.go

# 2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
tail -n 100 migration.log

# 3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
cat migration_state.json | jq '.'
```

**–ü–æ–ª–µ–∑–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã:**
- [Gemini API Documentation](https://ai.google.dev/docs)
- [PostgreSQL pgvector](https://github.com/pgvector/pgvector)
- [Issues](https://github.com/Henry-Case-dev/migrate-history-script/issues)

---

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - —Å–º. [LICENSE](LICENSE)

---

<div align="center">

**–ê–≤—Ç–æ—Ä:** [Henry-Case-dev](https://github.com/Henry-Case-dev)  
**–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π:** [migrate-history-script](https://github.com/Henry-Case-dev/migrate-history-script)  

‚≠ê –ü–æ—Å—Ç–∞–≤—å—Ç–µ –∑–≤–µ–∑–¥—É, –µ—Å–ª–∏ –ø—Ä–æ–µ–∫—Ç –±—ã–ª –ø–æ–ª–µ–∑–µ–Ω!

</div>
