#!/bin/bash

echo "üöÄ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –≤ PostgreSQL —Å –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π"
echo "============================================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –∏—Å—Ç–æ—Ä–∏–µ–π
if [ ! -d "../../–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞" ]; then
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è '–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    echo "   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
echo "üìä –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
echo "   PostgreSQL: $POSTGRESQL_HOST:$POSTGRESQL_PORT"
echo "   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $POSTGRESQL_DBNAME"
echo "   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $POSTGRESQL_USER"
echo "   –ú–æ–¥–µ–ª—å —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤: $GEMINI_EMBEDDING_MODEL_NAME"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏
history_size=$(du -sh "../../–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞" 2>/dev/null | cut -f1)
echo "üìÅ –†–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞: $history_size"
echo ""

# –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ JSON —Ñ–∞–π–ª–æ–≤
json_count=$(find "../../–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞" -name "*.json" | wc -l)
echo "üìÑ –ù–∞–π–¥–µ–Ω–æ JSON —Ñ–∞–π–ª–æ–≤: $json_count"
echo ""

echo "‚ö†Ô∏è  –í–ê–ñ–ù–û:"
echo "   - –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–π–º–µ—Ç –≤—Ä–µ–º—è (–ø—Ä–∏–º–µ—Ä–Ω–æ 1-3 –¥–Ω—è –¥–ª—è –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)"
echo "   - –°—Ç–æ–∏–º–æ—Å—Ç—å –≤–µ–∫—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ~$10-15"
echo "   - –ü—Ä–æ—Ü–µ—Å—Å –º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Ctrl+C –∏ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∂–µ"
echo "   - –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ migration_state.json"
echo ""

read -p "ü§î –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é? (y/N): " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞"
    exit 0
fi

echo ""
echo "üîÑ –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–∏..."
echo "   –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ migration.log"
echo "   –ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
echo ""

# –ó–∞–ø—É—Å–∫–∞–µ–º –º–∏–≥—Ä–∞—Ü–∏—é —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º
./migrate_history.exe 2>&1 | tee migration.log

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
if [ $? -eq 0 ]; then
    echo ""
    echo "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ migration_state.json –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
    echo "   –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ migration.log"
else
    echo ""
    echo "‚ùå –ú–∏–≥—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π"
    echo "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ migration.log –¥–ª—è –¥–µ—Ç–∞–ª–µ–π"
    echo "   –í—ã –º–æ–∂–µ—Ç–µ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ø–æ–∑–∂–µ"
    exit 1
fi
